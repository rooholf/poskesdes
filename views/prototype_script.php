<script>
const pages=document.querySelectorAll('[data-page]');
const navLinks=document.querySelectorAll('nav.top-nav a');
const bottomLinks=document.querySelectorAll('.bottom-nav a');
function openLoginModal(){ const m=document.getElementById('login-modal'); if(m){ m.classList.add('show'); document.body.classList.add('modal-open'); } }
function showPage(name){ const publicAllowed=new Set(['home','jadwal','edukasi']); if(!window.__isLoggedIn && !publicAllowed.has(name)){ openLoginModal(); return; } pages.forEach(p=>p.classList.toggle('active', p.id===name)); navLinks.forEach(a=>a.classList.toggle('active', a.dataset.route===name)); location.hash=name; const pageEl=document.getElementById(name); if(pageEl) pageEl.scrollTop=0; if(name==='home') updateHomeStats(); if(name==='anc-detail') populateDropdown('select-pasien-anc','info-pasien-anc'); if(name==='pelayanan-kb') populateDropdown('select-pasien-kb','info-pasien-kb'); if(name==='lansia-detail') populateDropdown('select-pasien-lansia','info-pasien-lansia'); if(name==='jadwal') loadJadwal(); if(name==='laporan'||name==='ekspor') updateLaporan(); }
const initialRaw=location.hash.replace('#','')||'home';
const initialAllowed=(window.__isLoggedIn?initialRaw:(['home','jadwal','edukasi'].includes(initialRaw)?initialRaw:'home'));
showPage(initialAllowed);
navLinks.forEach(a=>a.addEventListener('click',e=>{ e.preventDefault(); showPage(a.dataset.route); }));
bottomLinks.forEach(a=>a.addEventListener('click',()=>{ const mm=document.getElementById('modal'); const lm=document.getElementById('login-modal'); if(mm) mm.classList.remove('show'); if(lm) lm.classList.remove('show'); document.body.classList.remove('modal-open'); const target=a.dataset.link; if(target) showPage(target); }));
window.addEventListener('hashchange',()=>{ const h=location.hash.replace('#','')||'home'; showPage(h); });
document.querySelectorAll('[data-link]').forEach(el=>{ el.addEventListener('click',(e)=>{ if(e) e.preventDefault&&e.preventDefault(); const t=el.dataset.link; if(t) showPage(t); }); });
document.getElementById('open-login')&&document.getElementById('open-login').addEventListener('click',e=>{ e.preventDefault(); openLoginModal(); });
document.getElementById('open-login-bottom')&&document.getElementById('open-login-bottom').addEventListener('click',e=>{ e.preventDefault(); openLoginModal(); });
document.getElementById('login-close')&&document.getElementById('login-close').addEventListener('click',()=>{ const m=document.getElementById('login-modal'); if(m){ m.classList.remove('show'); document.body.classList.remove('modal-open'); } });
function openScheduleDetailById(id){ const list=window.__lastSchedules||[]; let d=list.find(x=> String(x.id)===String(id)); const setModal=(item)=>{ const t=document.getElementById('modal-title'); const b=document.getElementById('modal-body'); if(!t||!b) return; t.textContent=item.subject||item.service_type||'Jadwal'; b.innerHTML=`<div><div><strong>${formatTanggal(item.date||'')}</strong> ${item.time||''}</div><div class="muted">Jenis: ${item.service_type||''} • Pengingat: ${item.contact_method||''}</div><div style="margin-top:8px">${item.notes||''}</div></div>`; document.getElementById('modal').classList.add('show'); document.body.classList.add('modal-open'); }; if(!d){ apiGet('action=schedules_list').then(arr=>{ window.__lastSchedules=Array.isArray(arr)?arr:[]; const f=(window.__lastSchedules||[]).find(x=> String(x.id)===String(id)); if(f){ setModal(f); } }); return; } setModal(d); }
function hitungStatus(tanggalStr){ const today=new Date(); today.setHours(0,0,0,0); const tgl=new Date(tanggalStr); tgl.setHours(0,0,0,0); const selisihHari=Math.round((tgl-today)/(1000*60*60*24)); if(selisihHari<0)return'lewat'; if(selisihHari===0)return'hari-ini'; if(selisihHari===1)return'besok'; if(selisihHari<=7)return'minggu-ini'; return'lain'; }
function formatTanggal(t){ const d=new Date(t); return d.toLocaleDateString('id-ID',{day:'2-digit',month:'short',year:'numeric'}); }
function downloadCSV(filename,data){ if(data.length===0){ alert('Tidak ada data untuk diekspor.'); return; } const replacer=(k,v)=>{ if(v===null||typeof v==='undefined') return ''; if(typeof v==='string') return v.replace(/"/g,'""'); return v; }; const header=Object.keys(data[0]); let csv=data.map(row=>header.map(fieldName=>`"${replacer(fieldName,row[fieldName])}"`).join(',')); csv.unshift(header.join(',')); csv=csv.join('\r\n'); const blob=new Blob([csv],{type:'text/csv;charset=utf-8;'}); const link=document.createElement('a'); if(link.download!==undefined){ const url=URL.createObjectURL(blob); link.setAttribute('href',url); link.setAttribute('download',filename); link.style.visibility='hidden'; document.body.appendChild(link); link.click(); document.body.removeChild(link); } }
const agenda=[{title:'Imunisasi Polio',date:'21 Nov — 09:00',body:'Lokasi: Poskesdes. Vaksin untuk anak usia 0–5 tahun. Bawa KMS.'},{title:'ANC: Kontrol Ibu Hamil',date:'24 Nov — 10:30',body:'Bidan A. Persiapkan buku KIA dan catatan kehamilan.'}];
document.querySelectorAll('[data-agenda-open]').forEach(btn=>{ btn.addEventListener('click',()=>{ const i=Number(btn.dataset.agendaOpen); openModal(agenda[i]); }); });
function openModal(item){ document.getElementById('modal-title').textContent=item.title; document.getElementById('modal-body').innerHTML=`Tanggal: <strong>${item.date}</strong><p>${item.body}</p>`; document.getElementById('modal').classList.add('show'); document.body.classList.add('modal-open'); }
document.getElementById('modal-close').addEventListener('click',()=>{ document.getElementById('modal').classList.remove('show'); document.body.classList.remove('modal-open'); });
const jadwalList=document.getElementById('jadwal-list');
const jadwalKosong=document.getElementById('jadwal-kosong');
const API='api.php';
async function apiGet(path){ try{ const r=await fetch(`${API}?${path}`,{cache:'no-store'}); if(!r.ok){ return null; } return await r.json(); } catch(e){ return null; } }
async function apiPost(action, body){ const r=await fetch(`${API}?action=${action}`,{ method:'POST', headers:{'Content-Type':'application/x-www-form-urlencoded'}, body:new URLSearchParams(body) }); return r.json(); }
window.getPendaftar=async function(includeDummy=true){ const rows=await apiGet('action=patients_list'); if(rows.length===0 && includeDummy){ return [{ id:'D-1', nama:'Ibu Siti Aisyah (Dummy)', no_hp:'08123456789', alamat:'Dusun I', usia_kehamilan:'28' },{ id:'D-2', nama:'Ibu Fatimah Az-Zahra (Dummy)', no_hp:'08529876543', alamat:'Dusun II', usia_kehamilan:'12' },{ id:'D-3', nama:'Bapak Budi (Dummy Lansia)', no_hp:'08123445566', alamat:'Dusun III', usia_kehamilan:'0' }]; } return rows.map(p=>({ id:p.id, nama:p.name, no_hp:p.phone||'', alamat:p.address||'', usia_kehamilan:0 })); };
async function populateDropdown(selectId, infoId){ const select=document.getElementById(selectId); if(!select) return; const infoEl=document.getElementById(infoId); select.innerHTML='<option value="">-- Pilih Pasien Terdaftar --</option>'; if(infoEl) infoEl.textContent=''; const p_all=await window.getPendaftar(true); (Array.isArray(p_all)?p_all:[]).filter(pa=>pa&&pa.id).forEach(pa=>{ const opt=document.createElement('option'); opt.value=pa.id; if(selectId.includes('anc')){ opt.textContent=pa.nama + (pa.usia_kehamilan && pa.usia_kehamilan>0 ? (' — UK: '+pa.usia_kehamilan+' mg') : ' — Non Hamil'); } else { opt.textContent=pa.nama + (pa.no_hp ? (' — HP: '+pa.no_hp) : ''); } select.appendChild(opt); }); }
async function handlePasienSelect(selectEl, infoEl){ const pasienId=selectEl.value; const list=await window.getPendaftar(true); const pasien=(Array.isArray(list)?list:[]).find(p=> String(p.id)===String(pasienId)); if(pasien){ let infoText=`Nama: ${pasien.nama||'—'} | HP: ${pasien.no_hp||'—'}`; if(pasien.usia_kehamilan && pasien.usia_kehamilan>0){ infoText+=` | UK: ${pasien.usia_kehamilan} minggu`; } else { infoText+=` | Status: Non-Hamil`; } infoEl.textContent=infoText; } else { infoEl.textContent=''; } }
document.getElementById('select-pasien-anc').addEventListener('change',async e=>{ const select=e.target; const info=document.getElementById(select.dataset.infoTarget); await handlePasienSelect(select,info); });
document.getElementById('select-pasien-kb').addEventListener('change',async e=>{ const select=e.target; const info=document.getElementById(select.dataset.infoTarget); await handlePasienSelect(select,info); });
document.getElementById('select-pasien-lansia').addEventListener('change',async e=>{ const select=e.target; const info=document.getElementById(select.dataset.infoTarget); await handlePasienSelect(select,info); });
window.loadJadwal=async function(){ const data=await apiGet('action=schedules_list'); window.__lastSchedules = Array.isArray(data)?data:[]; if(!data||data.length===0){ jadwalKosong.style.display='block'; jadwalList.innerHTML=''; await updateLaporan(); await updateHomeStats(); return; } jadwalKosong.style.display='none'; data.sort((a,b)=> new Date(a.date)-new Date(b.date)); const pendaftar=await window.getPendaftar(false); const html=data.map(d=>{ const status=hitungStatus(d.date); let badgeText,badgeClass,waButton,borderStyle; if(status==='lewat'){badgeText='Lewat';badgeClass='badge-danger';borderStyle='var(--danger)';} else if(status==='hari-ini'){badgeText='Hari ini';badgeClass='badge-success';borderStyle='var(--success)';} else if(status==='besok'){badgeText='Besok (WA PENGINGAT)';badgeClass='badge-warning';borderStyle='var(--warning)';} else if(status==='minggu-ini'){badgeText='Minggu Ini';badgeClass='badge-muted';borderStyle='#ccc';} else {badgeText='Mendatang';badgeClass='badge-muted';borderStyle='#ccc';} const nama=d.subject||`${d.service_type}`; const pasienTerdaftar=pendaftar.find(p=> nama.includes(p.nama.split(' ')[0]) || nama.includes(p.nama)); let noHpBersih='62812xxxxxx'; let namaPasien=nama; if(pasienTerdaftar&&pasienTerdaftar.no_hp){ noHpBersih=pasienTerdaftar.no_hp.replace(/\D/g,''); if(!noHpBersih.startsWith('62') && noHpBersih.startsWith('0')){ noHpBersih='62'+noHpBersih.substring(1);} else if(!noHpBersih.startsWith('62')){ noHpBersih='62'+noHpBersih;} namaPasien=pasienTerdaftar.nama; } const pesan=encodeURIComponent(`*PEMBERITAHUAN JADWAL POSKESDES PAGAR RUYUNG*\n\nKepada Yth. Sdr/Ibu *${namaPasien}* Anda memiliki jadwal *${d.service_type}* pada:\n*Tanggal: ${formatTanggal(d.date)}*\n*Waktu: ${d.time||'09.00 - 14.00'} WIB*\n\nDiharapkan datang tepat waktu sesuai jadwal. Cara pengingat: ${d.contact_method||'Poskesdes'}\n\nTerima kasih.\n_Bidan Poskesdes Pagar Ruyung_`); const waLink=`https://wa.me/${noHpBersih}?text=${pesan}`; if(status==='hari-ini'||status==='besok'){ waButton=`<a href="${waLink}" target="_blank" class="small-btn" style="background:var(--success); color:#fff; font-size:11px; font-weight:700;">${status==='besok'?'KIRIM WA PENGINGAT':'KIRIM WA SEKARANG'}</a>`; } else { waButton=`<a href="${waLink}" target="_blank" class="small-btn" style="background:#e0f2f1; color:var(--teal-600); font-size:11px;">Kirim WA (Manual)</a>`; } const actionsLogged = window.__isLoggedIn ? `<button class=\"small-btn view-jadwal\" data-id=\"${d.id}\">Detail</button><button class=\"small-btn edit-jadwal\" data-id=\"${d.id}\">Edit</button><button class=\"small-btn delete-jadwal\" data-id=\"${d.id}\">Hapus</button>` : `<button class=\"small-btn view-jadwal\" data-id=\"${d.id}\">Detail</button>`; return `<div class=\"agenda item\" style=\"margin-top:6px; border-left: 4px solid ${borderStyle};\"><div style=\"flex-grow:1;\"><div style=\"font-weight:700\">${nama}</div><div class=\"muted\" style=\"font-size:13px\">${formatTanggal(d.date)} • ${d.service_type} • ${d.contact_method||''}</div></div><div style=\"text-align:right; display:flex; gap: 8px; align-items:center;\">${waButton}<span class=\"badge ${badgeClass}\">${badgeText}</span>${actionsLogged}</div></div>`; }).join(''); jadwalList.innerHTML=html; await updateLaporan(); await updateHomeStats(); };
jadwalList&&jadwalList.addEventListener('click',async e=>{ const t=e.target; if(t.classList.contains('view-jadwal')){ openScheduleDetailById(t.dataset.id); } else if(t.classList.contains('edit-jadwal')){ const d=(window.__lastSchedules||[]).find(x=> String(x.id)===String(t.dataset.id)); if(!d){ return; } const m=document.getElementById('modal'); const b=document.getElementById('modal-body'); const tt=document.getElementById('modal-title'); if(m&&b&&tt){ tt.textContent='Ubah Jadwal'; b.innerHTML=`<form id=\"edit-jadwal-form\"><input type=\"hidden\" name=\"id\" value=\"${d.id}\" /><label>Nama<input name=\"nama\" value=\"${d.subject||''}\"></label><label>Tanggal<input type=\"date\" name=\"tanggal\" value=\"${d.date||''}\"></label><label>Jenis<select name=\"jenis\"><option ${d.service_type==='ANC Kontrol'?'selected':''}>ANC Kontrol</option><option ${d.service_type==='KB Kontrol'?'selected':''}>KB Kontrol</option><option ${d.service_type==='Lansia Kontrol'?'selected':''}>Lansia Kontrol</option><option ${d.service_type==='Imunisasi'?'selected':''}>Imunisasi</option><option ${d.service_type==='Lainnya'?'selected':''}>Lainnya</option></select></label><label>Cara<select name=\"cara\"><option ${d.contact_method==='Telepon/WA'?'selected':''}>Telepon/WA</option><option ${d.contact_method==='Kunjungan'?'selected':''}>Kunjungan</option><option ${d.contact_method==='Poskesdes'?'selected':''}>Poskesdes</option></select></label><label>Waktu<input name=\"waktu\" value=\"${d.time||''}\"></label><label>Catatan<input name=\"catatan\" value=\"${d.notes||''}\"></label><div style=\"text-align:right;margin-top:10px\"><button class=\"btn-primary\" type=\"submit\">Simpan</button></div></form>`; m.classList.add('show'); document.body.classList.add('modal-open'); } } else if(t.classList.contains('delete-jadwal')){ if(!window.__isLoggedIn){ openLoginModal(); return; } const id=t.dataset.id; const ok=confirm('Hapus jadwal ini?'); if(!ok) return; const res=await apiPost('schedules_delete',{id}); if(res&&res.ok){ await loadJadwal(); } } });
const registerForm=document.getElementById('form-register-pasien');
if(registerForm){ registerForm.addEventListener('submit',async e=>{ e.preventDefault(); const body=Object.fromEntries(new FormData(registerForm).entries()); const res=await apiPost('patients_add',body); if(res&&res.ok){ registerForm.reset(); await populateDropdown('select-pasien-anc','info-pasien-anc'); await populateDropdown('select-pasien-kb','info-pasien-kb'); await populateDropdown('select-pasien-lansia','info-pasien-lansia'); showPage('home'); } }); }
const formJadwal=document.getElementById('form-jadwal');
if(formJadwal){ formJadwal.addEventListener('submit',async e=>{ e.preventDefault(); const body=Object.fromEntries(new FormData(formJadwal).entries()); const res=await apiPost('schedules_add',body); if(res&&res.ok){ formJadwal.reset(); await loadJadwal(); alert('Jadwal baru tersimpan ke database.'); } }); }
const ancForm=document.getElementById('form-anc');
if(ancForm){ ancForm.addEventListener('submit',async e=>{ e.preventDefault(); const pasienId=document.getElementById('select-pasien-anc').value; if(!pasienId){ alert('Pilih Pasien terlebih dahulu!'); return; } const pasienNameEl=document.getElementById('info-pasien-anc'); const pasienName=pasienNameEl ? (pasienNameEl.textContent.replace('Nama: ','').split(' | ')[0]||'') : ''; const body=Object.fromEntries(new FormData(ancForm).entries()); await apiPost('anc_add',{ patient_id:pasienId, patient_name:pasienName, tanggal:new Date().toISOString().substring(0,10), jadwal_kontrol:body.jadwal_kontrol_berikut||'', data_json:JSON.stringify(body) }); ancForm.reset(); document.getElementById('select-pasien-anc').value=''; document.getElementById('info-pasien-anc').textContent=''; await loadJadwal(); await updateLaporan(); showPage('jadwal'); }); }
const kbForm=document.getElementById('form-kb');
if(kbForm){ kbForm.addEventListener('submit',async e=>{ e.preventDefault(); const pasienId=document.getElementById('select-pasien-kb').value; if(!pasienId){ alert('Pilih Pasien terlebih dahulu!'); return; } const pasienNameEl=document.getElementById('info-pasien-kb'); const pasienName=pasienNameEl ? (pasienNameEl.textContent.replace('Nama: ','').split(' | ')[0]||'') : ''; const body=Object.fromEntries(new FormData(kbForm).entries()); await apiPost('kb_add',{ patient_id:pasienId, patient_name:pasienName, tanggal:new Date().toISOString().substring(0,10), jadwal_kontrol:body.jadwal_kontrol_kb||'', data_json:JSON.stringify(body) }); kbForm.reset(); document.getElementById('select-pasien-kb').value=''; document.getElementById('info-pasien-kb').textContent=''; await loadJadwal(); await updateLaporan(); showPage('jadwal'); }); }
const lansiaForm=document.getElementById('form-lansia');
if(lansiaForm){ lansiaForm.addEventListener('submit',async e=>{ e.preventDefault(); const pasienId=document.getElementById('select-pasien-lansia').value; if(!pasienId){ alert('Pilih Pasien terlebih dahulu!'); return; } const pasienNameEl=document.getElementById('info-pasien-lansia'); const pasienName=pasienNameEl ? (pasienNameEl.textContent.replace('Nama: ','').split(' | ')[0]||'') : ''; const body=Object.fromEntries(new FormData(lansiaForm).entries()); await apiPost('lansia_add',{ patient_id:pasienId, patient_name:pasienName, tanggal:new Date().toISOString().substring(0,10), jadwal_kontrol:body.jadwal_kontrol_lansia||'', data_json:JSON.stringify(body) }); lansiaForm.reset(); document.getElementById('select-pasien-lansia').value=''; document.getElementById('info-pasien-lansia').textContent=''; await loadJadwal(); await updateLaporan(); showPage('jadwal'); }); }
async function updateLaporan(){ const s=await apiGet('action=summary'); document.getElementById('lap-total-pendaftar').textContent=s.pendaftar; document.getElementById('lap-total-anc').textContent=s.anc; document.getElementById('lap-total-kb').textContent=s.kb; document.getElementById('lap-total-lansia').textContent=s.lansia; document.getElementById('lap-total-jadwal').textContent=s.jadwal_aktif; const laporanJadwalEl=document.getElementById('laporan-jadwal'); const header=`<div class="header"><span>No</span><span>Pasien</span><span>Tanggal</span><span>Jenis</span></div>`; const listData=await apiGet('action=schedules_list'); if(!listData||listData.length===0){ laporanJadwalEl.innerHTML=header + '<div style="grid-template-columns:1fr; text-align:center; padding:10px;">Tidak ada jadwal.</div>'; return; } const list=listData.filter(d=> hitungStatus(d.date) !== 'lewat').slice(0,5).map((d,i)=>`<div><span>${i+1}</span><span>${d.subject||d.service_type}</span><span>${formatTanggal(d.date)}</span><span>${d.service_type}</span></div>`).join(''); laporanJadwalEl.innerHTML=header + list; }
async function updateHomeStats(){ const s=await apiGet('action=summary'); if(!s) return; const elJ=document.getElementById('home-total-jadwal'); const elP=document.getElementById('home-total-pendaftar'); const elK=document.getElementById('home-total-kunjungan'); if(elJ) elJ.textContent = s.jadwal_aktif; if(elP) elP.textContent = s.pendaftar; if(elK) elK.textContent = (Number(s.anc||0)+Number(s.kb||0)+Number(s.lansia||0)); }
async function updateHomeAgenda(){ const data=await apiGet('action=schedules_list'); window.__lastSchedules = Array.isArray(data)?data:[]; const wrap=document.getElementById('home-agenda'); if(!wrap){ return; } if(!data||data.length===0){ wrap.innerHTML='<div class="muted" style="padding:10px;text-align:center;">Belum ada agenda terdekat.</div>'; return; } const today=new Date(); const upcoming=data.filter(d=> new Date(d.date)>=today).sort((a,b)=> new Date(a.date)-new Date(b.date)).slice(0,3); if(upcoming.length===0){ wrap.innerHTML='<div class="muted" style="padding:10px;text-align:center;">Belum ada agenda terdekat.</div>'; return; } wrap.innerHTML=upcoming.map(d=>`<div class="item"><div><div style="font-weight:700">${d.subject||d.service_type} — ${d.time||''}</div><div class="muted">${formatTanggal(d.date)} — ${d.notes||''}</div></div><div><button class="small-btn agenda-detail" data-id="${d.id}">Detail</button></div></div>`).join(''); document.getElementById('home-agenda').addEventListener('click',e=>{ const t=e.target; if(t.classList.contains('agenda-detail')){ openScheduleDetailById(t.dataset.id); } }); }
function toObj(v){ try{ if(typeof v==='string'){ return JSON.parse(v||'{}'); } if(v&&typeof v==='object'){ return v; } return {}; }catch(e){ return {}; } }
document.getElementById('btn-export-summary-bulan').addEventListener('click',async ()=>{ const anc=await apiGet('action=export_anc'); const kb=await apiGet('action=export_kb'); const months=["Januari","Februari","Maret","April","Mei","Juni","Juli","Agustus","September","Oktober","November","Desember"]; let map={}; const init=(key)=>{ if(!map[key]){ map[key]={ Bulan: `${months[parseInt(key.substring(5,7))-1]} ${key.substring(0,4)}`, 'K1 Total':0, 'K Lanjut (K4, K5, K6)':0, 'Ibu Hamil Komplikasi':0, 'KB Baru':0, 'KB Drop Out/Gagal/Komplikasi':0, 'KB Aktif':0 }; } }; (anc||[]).forEach(r=>{ const date=r.tanggal; const ym=date.substring(0,7); init(ym); const d=toObj(r.data); if(d.anc_k_status==='K1') map[ym]['K1 Total']++; if(['K-Lanjut','K4','K5','K6'].includes(d.anc_k_status)) map[ym]['K Lanjut (K4, K5, K6)']++; if(d.klasifikasi_risiko==='tinggi' || d.klasifikasi_risiko==='gawat_darurat') map[ym]['Ibu Hamil Komplikasi']++; }); (kb||[]).forEach(r=>{ const date=r.tanggal; const ym=date.substring(0,7); init(ym); const d=toObj(r.data); if(d.kb_status_peserta==='Baru') map[ym]['KB Baru']++; if(['DropOut','Gagal','Komplikasi'].includes(d.kb_status_peserta)) map[ym]['KB Drop Out/Gagal/Komplikasi']++; map[ym]['KB Aktif']++; }); const arr=Object.keys(map).sort().map(k=>map[k]); if(arr.length===0){ alert('Tidak ada data rekam ANC atau KB yang tercatat.'); return; } downloadCSV('laporan_bulanan_ringkas.csv',arr); });
document.getElementById('btn-export-pendaftar').addEventListener('click',async ()=>{ const arr=await apiGet('action=export_pendaftar'); if(arr&&arr.length){ downloadCSV('pendaftar_poskesdes.csv',arr); } });
document.getElementById('btn-export-jadwal').addEventListener('click',async ()=>{ const arr=await apiGet('action=export_jadwal'); if(arr&&arr.length){ downloadCSV('jadwal_poskesdes.csv',arr); } });
document.getElementById('btn-export-anc').addEventListener('click',async ()=>{ const arr=await apiGet('action=export_anc'); const mapped=(arr||[]).map(r=>{ const d=toObj(r.data); return { id:r.id, pasien_nama:r.pasien_nama||'', tanggal_kunjungan:r.tanggal||'', kunjungan_ke:d.anc_kunjungan_ke||'', k_status:d.anc_k_status||'', gravida:d.gravida||'', para:d.para||'', td:d.td||'', djj:d.djj||'', risiko:d.faktor_risiko||'', jadwal_kontrol_berikut:d.jadwal_kontrol_berikut||'', ringkasan:d.ringkasan_kunjungan||'' }; }); if(mapped.length){ downloadCSV('rekam_anc_poskesdes.csv',mapped); } });
document.getElementById('btn-export-kb').addEventListener('click',async ()=>{ const arr=await apiGet('action=export_kb'); const mapped=(arr||[]).map(r=>{ const d=toObj(r.data); return { id:r.id, pasien_nama:r.pasien_nama||'', tanggal_kunjungan:r.tanggal||'', metode_kb:d.metode_kb||'', status_peserta:d.kb_status_peserta||'', tgl_mulai:d.tgl_mulai||'', jadwal_kontrol_kb:d.jadwal_kontrol_kb||'', keterangan:d.keterangan||'' }; }); if(mapped.length){ downloadCSV('rekam_kb_poskesdes.csv',mapped); } });
document.getElementById('btn-export-lansia').addEventListener('click',async ()=>{ const arr=await apiGet('action=export_lansia'); const mapped=(arr||[]).map(r=>{ const d=toObj(r.data); return { id:r.id, pasien_nama:r.pasien_nama||'', tanggal_kunjungan:r.tanggal||'', keluhan:d.keluhan_lansia||'', diagnosa:d.diagnosa_lansia||'', td:d.td_lansia||'', gds:d.gds||'', asam_urat:d.asam_urat||'', kolesterol:d.kolesterol||'', tindakan:d.tindakan_lansia||'', jadwal_kontrol_berikut:d.jadwal_kontrol_lansia||'' }; }); if(mapped.length){ downloadCSV('rekam_lansia_poskesdes.csv',mapped); } });
document.querySelectorAll('.svc').forEach(el=>{ el.addEventListener('click',()=>{ const route=el.dataset.link; if(route) showPage(route); }); });
(async function(){ try { await updateHomeStats(); await updateHomeAgenda(); if(window.__isLoggedIn){ await loadJadwal(); await updateLaporan(); } else { await loadJadwal(); } } catch(e){} })();
</script>
